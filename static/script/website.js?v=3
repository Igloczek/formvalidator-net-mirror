(function($, window) {

    'use strict';

    var $win = $(window),
        viewMode = 'desktop';

    if( $win.width() < 600 ) {
        $('.linenums').removeClass('linenums');
    }

    // Syntax highlighting... prettyprint
    $('.convert-code').each(function() {
        var html = this.innerHTML;
        $(this)
            .html('')
            .text($.trim(html))
            .show();
    });
    if( navigator.userAgent.indexOf('MSIE') > -1 ) {
        $('.prettyprint').addClass('linenums'); // IE must have line numbers or line breaks will disappear
    }
    $('.prettyprint').each(function() {
        var code = $(this).text().replace(new RegExp('    ', 'g'), '  ');
        code = code.replace(new RegExp('break[0-9]?=""', 'gi'), '\n\t\t');
        $(this).text( code );
    });
    prettyPrint();

    /*
     * Download curtain
     */
    var $downloadInfo = $('#download-info');
    $('#download-link').click(function(evt) {
        if( $downloadInfo.is(':visible') ) {
            $(this).removeClass('active');
            $downloadInfo.slideUp();
        } else {
            $(this).addClass('active');
            $downloadInfo.slideDown();
        }
        return false;
    });

    // Links on front page that opens download curtain
    $('#home').find('.click-download').click(function() {
        $('#download-link').trigger('click');
        return false;
    });

    // Register page views at ga
    $win.on('hashchange', function() {
        var url = window.location.pathname + window.location.search + window.location.hash;
        if( typeof window.ga == 'function' ) {
            ga('send', 'pageview', url);
        } else {
            console.log('Would register page view for '+url+' in production');
        }
        if( viewMode == 'mobile' ) {
            if( $('#side-col').is(':visible') ) {
                $('.nav-toggle').trigger('click');
            }
        }

      if( !Pager.isFirstLoad ) {
        var $adWrapper = $('#ad-wrapper');
        $adWrapper
          .css('height', $adWrapper.height()+'px')
          .html('<div id="carbonads-container"><div class="carbonad"><div id="azcarbon"></div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=formvalidatornet" id="_carbonads_js"></script></div></div>');

        setTimeout(function() {
          $adWrapper.css('height', 'auto');
          $adWrapper.find('img').on('load', function() {
            $adWrapper.css('height', 'auto');
          })
        }, 1000);
      }
    });

    var hasLoadedProfilePics = false,
        addProfilePicToDOM = function(url, link) {
            link.innerHTML = '<img src="'+url+'" alt="" class="profile-pic" /> '+ link.innerHTML;
        };

    $win.on('pageChange', function(evt, page, args, pageSection) {

        if( !hasLoadedProfilePics && page == 'credits' ) {
            // Load profile pics
            hasLoadedProfilePics = true;
            $('a.profile').each(function() {
                var check = $(this).attr('data-github') || this.href;
                if( check.indexOf('github.com/') > -1 ) {
                    addProfilePicToDOM('static/img/profiles/' +check.split('ithub.com/')[1]+ '.png', this);
                } else {
                    addProfilePicToDOM('static/img/profiles/no-img.png', this);
                }
            });
        }
    });

    // Preload some images that is used in the form
    $.each(['static/img/icon-fail.png', 'static/img/icon-ok.png'], function(i, imgSource) {
        $('<img />')
            .css({
                position : 'absolute',
                top: '-100px',
                left: '-100px'
            })
            .appendTo('body')
            .get(0).src = imgSource;
    });

    // Setup form validation
    $.validate({
        form : '.test-form:not(.top-messages)',
        modules : 'date, security, location, date, sweden, uk, file.dev',
        onModulesLoaded: function($form) {
            $('input[name="country"]').suggestCountry();
            $('input[name="state"]').suggestState();
            $('input[name="lan"]').suggestSwedishCounty();
            $('input[name="kommun"]').suggestSwedishMunicipality();
            $('input[name="pass_confirmation"]').displayPasswordStrength();
        },
        onError : function() {

        },
        onSuccess: function($form) {

            // if "validate_backend" is encountered the form will be validated
            // twice, the first time $.formUtils.haltValidation will be set to true
            if( !$.formUtils.haltValidation ) {
                alert('Form is valid :)');

                // The input button is disabled if the form contains backend validations
                $form.find('input[type="submit"]').unbind('click');
            }
            return false;
        }
    });

    // Setup form validation with error messages in top
    $.validate({
        form : '.test-form.top-messages',
        scrollToTopOnError: false,
        validateOnBlur: false,
        errorMessagePosition: 'top',
        onSuccess : function() {
            alert('The form is valid :)');
            return false;
        }
    });

    // Length restrictions
    $('.length-restricted').each(function() {
        var $maxLen = $(this).parent().parent().parent().find('.max-chars');
        $(this).restrictLength($maxLen);
    });

    // Bind card type to card number validator
    $('#ccard').on('change', function() {
        var card = $(this).val();
        $('input[name="ccard_num"]').attr('data-validation-allowing', card);
    });

    // Responsive stuff
    $win.on('viewModeChange', function(evt, newMode) {
        viewMode = newMode;
    });

})(jQuery, window);